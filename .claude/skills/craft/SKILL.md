---
name: craft
description: "Craft something new. Smart flow adapts to your situation: existing project, from scratch, with inspiration. Reactive agents collaborate intelligently."
context: conversation
allowed-tools: Read, Bash, Task, AskUserQuestion, Glob, Grep, WebFetch
---

# Spectre Craft â€” Smart Reactive Flow

Intelligent flow that adapts to your situation AND your input.

---

## The Smart Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚  /craft                                                          â”‚
â”‚      â”‚                                                           â”‚
â”‚      â–¼                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  1. PROJECT DETECTION               â”‚                        â”‚
â”‚  â”‚     Existing code? Stack?           â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                â”‚                                                 â”‚
â”‚                â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  2. WORK CONTEXT                    â”‚                        â”‚
â”‚  â”‚     Product / Startup / Freelance   â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                â”‚                                                 â”‚
â”‚                â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  3. WHAT TO BUILD?                  â”‚                        â”‚
â”‚  â”‚     User describes feature/idea     â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                â”‚                                                 â”‚
â”‚                â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  4. INPUT ANALYSIS â† NEW!           â”‚                        â”‚
â”‚  â”‚     Detect input type & route       â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                â”‚                                                 â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚       â”‚        â”‚        â”‚          â”‚                            â”‚
â”‚       â–¼        â–¼        â–¼          â–¼                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”                          â”‚
â”‚    â”‚ Ideaâ”‚  â”‚Func â”‚  â”‚Tech â”‚  â”‚Bug/ â”‚                          â”‚
â”‚    â”‚ raw â”‚  â”‚Spec â”‚  â”‚Spec â”‚  â”‚Fix  â”‚                          â”‚
â”‚    â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜                          â”‚
â”‚       â”‚        â”‚        â”‚        â”‚                              â”‚
â”‚       â–¼        â–¼        â–¼        â–¼                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”                          â”‚
â”‚    â”‚ PO  â”‚  â”‚Archiâ”‚  â”‚ Dev â”‚  â”‚ Dev â”‚                          â”‚
â”‚    â”‚firstâ”‚  â”‚firstâ”‚  â”‚firstâ”‚  â”‚only â”‚                          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                  â”‚
â”‚                â–¼                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  5. REACTIVE PARALLEL EXECUTION     â”‚                        â”‚
â”‚  â”‚     Agents work & collaborate       â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Step 1: Project Detection

```bash
# Check for existing project
if [ -f "package.json" ] || [ -f "go.mod" ] || [ -f "Cargo.toml" ]; then
  FROM_SCRATCH=false
  # â†’ Auto-detect stack, trigger /learn
else
  FROM_SCRATCH=true
  # â†’ Ask for stack
fi
```

### If From Scratch â†’ Ask Stack

```
Question: "What stack?"
Header: "Stack"
Options:
  1. "TypeScript + React" - Frontend with Vite
  2. "TypeScript + Node" - Backend API
  3. "Full-stack TypeScript" - React + Node
  4. "Go" - Backend with Go
```

---

## Step 2: Work Context

```
Question: "What's your work context?"
Header: "Context"
Options:
  1. "Product Team" - Full process: PO â†’ Architect â†’ Dev â†’ QA
  2. "Startup" - Fast: Architect â†’ Dev â†’ QA
  3. "Freelance" - Efficient: Dev â†’ QA
  4. "Learning" - Educational: Single agent explains
```

---

## Step 3: What to Build

```
Question: "What do you want to build?"
Header: "Feature"
# Free text input - user describes their idea/feature/spec
```

---

## Step 4: Input Analysis (THE SMART PART)

**ABSOLUTE RULE: All agents work from a spec in MD format.**

The PO's job is to ensure a proper `.md` spec exists. Other agents (Architect, Dev, QA) CANNOT start without it.

### What counts as a valid spec?

A valid spec file contains:
- User story format (As a... I want... So that...)
- Acceptance criteria (Given/When/Then or checkboxes)
- Edge cases considered
- Out of scope defined

### Input Types & Routing

| Input | Has Valid Spec? | Route |
|-------|-----------------|-------|
| Spec file (`.md`, `.yml`) | âœ… YES | â†’ Architect (reads file) |
| "a sexy counter" | âŒ NO | â†’ **PO creates spec.md** â†’ Architect |
| "Counter with +/-, localStorage, dark mode" | âŒ NO (detailed but informal) | â†’ **PO creates spec.md** â†’ Architect |
| "Jira ticket: PROJ-123" | âŒ NO (external, not formatted) | â†’ **PO fetches + creates spec.md** â†’ Architect |
| "Create Counter.tsx with useState..." | âŒ NO (technical, no spec) | â†’ **PO creates spec.md** â†’ Architect |
| "Fix the counter reset bug" | N/A (bug fix) | â†’ Dev only |

### Why Always MD Spec?

1. **Architect** needs clear requirements to design
2. **Dev** needs acceptance criteria to implement
3. **QA** needs test scenarios to verify
4. **Everyone** needs a single source of truth

The PO transforms ANY input into a proper spec.md that becomes the contract for all agents.

### PO Output: Always .spectre/spec.md

```markdown
# Feature: [Feature Name]

## User Story
As a [user type], I want [feature]
so that [benefit].

## Acceptance Criteria
- [ ] Given... When... Then...
- [ ] Given... When... Then...

## Edge Cases
- What if...?
- What about...?

## Out of Scope
- Not doing X in this iteration
- Y will be handled separately

## Technical Notes (optional)
- Constraints mentioned by user
- Performance requirements
```

This file is created by PO and used by ALL other agents.

### Detection Logic

```
ANALYZE the user's input:

# Check for REAL spec source
IF input references a file (*.md, *.yml, *.yaml, *.json):
  â†’ READ the file
  â†’ IF file contains proper spec format:
    â†’ INPUT_TYPE = "spec_file"
    â†’ NEEDS_PO = false
    â†’ "Spec file provided. Architect can design."

ELSE IF input contains URL (jira, linear, notion, github issue):
  â†’ FETCH the URL content
  â†’ INPUT_TYPE = "external_spec"
  â†’ NEEDS_PO = false
  â†’ "External spec source. Architect can design."

ELSE IF input is clearly a bug fix (references existing file + problem):
  â†’ INPUT_TYPE = "bug_fix"
  â†’ NEEDS_PO = false
  â†’ NEEDS_ARCHITECT = false
  â†’ "Bug fix. Dev handles directly."

ELSE:
  # ANY other text input = PO first
  â†’ INPUT_TYPE = "needs_spec"
  â†’ NEEDS_PO = true
  â†’ "No formal spec. PO will create one first."
```

### Inform the User

```
Based on your input, here's the plan:

ğŸ“ Input type: Raw idea
ğŸ¯ Flow: PO â†’ Architect â†’ Dev â‡„ QA

The Product Owner will first create a proper spec from your idea,
then the Architect will design the technical solution.

[Start] [I have more details to add]
```

---

## Step 5: Smart Routing by Input Type

### Route A: Raw Idea â†’ PO First

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER INPUT: "a sexy counter"                                    â”‚
â”‚                                                                  â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚       â”‚    PO    â”‚ â† Creates functional spec                    â”‚
â”‚       â”‚  (spec)  â”‚                                              â”‚
â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚            â”‚ user story + acceptance criteria                   â”‚
â”‚            â–¼                                                     â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚       â”‚ Architectâ”‚ â† Creates technical design                   â”‚
â”‚       â”‚ (design) â”‚                                              â”‚
â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚            â”‚ architecture + file structure                      â”‚
â”‚            â–¼                                                     â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚       â”‚      PARALLEL           â”‚                               â”‚
â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚                               â”‚
â”‚       â”‚  â”‚ Dev  â”‚  â”‚  QA  â”‚    â”‚                               â”‚
â”‚       â”‚  â”‚impl  â”‚â‡„â”‚tests â”‚    â”‚                               â”‚
â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜    â”‚                               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**PO Output:**
```markdown
## User Story
As a user, I want a visually appealing counter
so that I can track a value with delight.

## Acceptance Criteria
- [ ] Counter displays current value (starts at 0)
- [ ] Increment button (+1) with satisfying animation
- [ ] Decrement button (-1) with animation
- [ ] Reset button
- [ ] Value persists across page refresh
- [ ] Dark/light mode toggle
- [ ] Micro-interactions on hover/click
- [ ] Accessible (keyboard nav, screen reader)

## Edge Cases
- Negative values allowed? â†’ Ask user or default to yes
- Max value? â†’ No limit unless specified
```

### Route B: Real Spec File/URL â†’ Architect First

Only when a REAL spec source is provided (file, Jira, etc.):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER INPUT: "See spec in docs/counter-spec.md"                 â”‚
â”‚         or: "Jira ticket PROJ-123"                              â”‚
â”‚         or: "GitHub issue #45"                                  â”‚
â”‚                                                                  â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚       â”‚ Architectâ”‚ â† Reads spec, designs technical solution     â”‚
â”‚       â”‚ (design) â”‚                                              â”‚
â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚            â”‚                                                     â”‚
â”‚            â–¼                                                     â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚       â”‚      PARALLEL           â”‚                               â”‚
â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚                               â”‚
â”‚       â”‚  â”‚ Dev  â”‚  â”‚  QA  â”‚    â”‚                               â”‚
â”‚       â”‚  â”‚impl  â”‚â‡„â”‚tests â”‚    â”‚                               â”‚
â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜    â”‚                               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Route C: Detailed Text Description â†’ STILL PO First!

Even detailed descriptions need PO to formalize:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER INPUT: "Counter with +/-, localStorage, dark mode"        â”‚
â”‚                                                                  â”‚
â”‚  âš ï¸ This is NOT a spec! It's a detailed idea.                   â”‚
â”‚     PO will formalize it with proper acceptance criteria.       â”‚
â”‚                                                                  â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚       â”‚    PO    â”‚ â† Formalizes into spec (light)               â”‚
â”‚       â”‚  (spec)  â”‚                                              â”‚
â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚            â”‚                                                     â”‚
â”‚            â–¼                                                     â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚       â”‚ Architectâ”‚                                              â”‚
â”‚       â”‚ (design) â”‚                                              â”‚
â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚            â”‚                                                     â”‚
â”‚            â–¼                                                     â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚       â”‚      PARALLEL           â”‚                               â”‚
â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”    â”‚                               â”‚
â”‚       â”‚  â”‚ Dev  â”‚  â”‚  QA  â”‚    â”‚                               â”‚
â”‚       â”‚  â”‚impl  â”‚â‡„â”‚tests â”‚    â”‚                               â”‚
â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜    â”‚                               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Route D: Bug Fix â†’ Dev Only

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER INPUT: "Fix the counter not persisting on refresh"        â”‚
â”‚                                                                  â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚       â”‚ Dev  â”‚ â”€â”€â”€â–¶ â”‚  QA  â”‚                                    â”‚
â”‚       â”‚ fix  â”‚      â”‚verifyâ”‚                                    â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Parallel Execution: Dev â‡„ QA

The magic: **Dev and QA work in parallel**, not sequentially.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PARALLEL REACTIVE LOOP                         â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚    Dev implements          QA writes tests              â”‚  â”‚
â”‚   â”‚         â”‚                        â”‚                       â”‚  â”‚
â”‚   â”‚         â”‚   â† shares context â†’   â”‚                       â”‚  â”‚
â”‚   â”‚         â”‚                        â”‚                       â”‚  â”‚
â”‚   â”‚         â–¼                        â–¼                       â”‚  â”‚
â”‚   â”‚    Code ready              Tests ready                   â”‚  â”‚
â”‚   â”‚         â”‚                        â”‚                       â”‚  â”‚
â”‚   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚  â”‚
â”‚   â”‚                  â”‚                                       â”‚  â”‚
â”‚   â”‚                  â–¼                                       â”‚  â”‚
â”‚   â”‚            QA runs tests                                 â”‚  â”‚
â”‚   â”‚                  â”‚                                       â”‚  â”‚
â”‚   â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                               â”‚  â”‚
â”‚   â”‚         â”‚               â”‚                               â”‚  â”‚
â”‚   â”‚        PASS            FAIL                              â”‚  â”‚
â”‚   â”‚         â”‚               â”‚                               â”‚  â”‚
â”‚   â”‚         â–¼               â–¼                               â”‚  â”‚
â”‚   â”‚       Done         Dev fixes                            â”‚  â”‚
â”‚   â”‚                        â”‚                                â”‚  â”‚
â”‚   â”‚                        â””â”€â”€â”€â”€â”€â”€â–¶ QA re-runs              â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### How Parallel Works

1. **Architect** outputs design with:
   - File structure
   - Component specs
   - Acceptance criteria (for QA)

2. **Dev starts** implementing from the design

3. **QA starts** writing tests from acceptance criteria
   - Doesn't wait for Dev to finish
   - Writes test shells based on expected behavior

4. **When Dev completes a component**, QA runs its tests

5. **If tests fail**, Dev gets immediate feedback and fixes

6. **Loop continues** until all tests pass

---

## Agent Prompts

### PO Prompt (Raw Idea â†’ Spec)

```
Task(
  subagent_type: "product-owner",
  prompt: """
    USER'S IDEA: <raw idea>
    STACK: <detected or chosen stack>

    ## Your Job

    Transform this raw idea into a proper functional specification.

    ## Output Format

    ### User Story
    As a [user type], I want [feature]
    so that [benefit].

    ### Acceptance Criteria
    - [ ] Criterion 1 (specific, testable)
    - [ ] Criterion 2
    - [ ] ...

    ### Edge Cases
    - What happens if...?
    - What about...?

    ### Out of Scope (for this iteration)
    - Things to explicitly NOT do now

    ### Questions for User (if any)
    - Clarifications needed before proceeding

    ## Rules
    - Be specific and testable
    - Think about edge cases
    - Consider accessibility
    - Keep scope reasonable for first iteration
  """
)
```

### Architect Prompt (Spec â†’ Design)

**ABSOLUTE RULE: Architect outputs `.spectre/design.md`. Dev and QA implement it TO THE LETTER.**

```
Task(
  subagent_type: "architect",
  prompt: """
    ## CONTEXT

    FUNCTIONAL SPEC: .spectre/spec.md
    STACK: <stack>
    CRAFT PRINCIPLES: Result<T,E>, strict TypeScript, hexagonal

    ## Your Job

    Create the technical design document that Dev and QA will implement EXACTLY.

    ## OUTPUT: .spectre/design.md

    You MUST write to `.spectre/design.md` with this structure:

    ```markdown
    # Technical Design: [Feature Name]

    ## Overview
    Brief description of the technical approach.

    ## Architecture Decision
    Why this approach? What alternatives were considered?

    ## File Structure
    EXACT files to create (Dev will create THESE files, no more, no less):

    ```
    src/features/<feature>/
    â”œâ”€â”€ domain/
    â”‚   â”œâ”€â”€ <Entity>.ts           # Description
    â”‚   â””â”€â”€ <ValueObject>.ts      # Description
    â”œâ”€â”€ application/
    â”‚   â””â”€â”€ use<UseCase>.ts       # Description
    â”œâ”€â”€ infrastructure/
    â”‚   â””â”€â”€ <Adapter>.ts          # Description
    â””â”€â”€ ui/
        â”œâ”€â”€ <Component>.tsx       # Description
        â””â”€â”€ <Component>.test.tsx  # Description
    ```

    ## Implementation Details

    ### File: src/features/<feature>/domain/<Entity>.ts
    - Purpose: ...
    - Exports: ...
    - Key types: ...
    - Craft patterns: Result<T, E>, no throw

    ### File: src/features/<feature>/application/use<UseCase>.ts
    - Purpose: ...
    - Dependencies: ...
    - Returns: Result<T, E>

    (etc. for each file)

    ## Test Specifications (for QA)
    EXACT tests to write:

    - [ ] `<Component>.test.tsx`: "should render initial state"
    - [ ] `<Component>.test.tsx`: "should handle increment"
    - [ ] `use<UseCase>.test.ts`: "should return Ok on success"
    - [ ] `use<UseCase>.test.ts`: "should return Err on failure"

    ## Craft Checklist
    - [ ] No `any` types
    - [ ] All errors as Result<T, E>
    - [ ] Domain isolated from framework
    - [ ] Tests colocated
    - [ ] Strict TypeScript
    ```

    ## IMPORTANT

    Dev and QA will implement THIS DOCUMENT exactly.
    - Dev creates the EXACT files listed
    - Dev uses the EXACT patterns specified
    - QA writes the EXACT tests listed
    - No deviation without coming back to you

    The design.md IS the implementation contract.
  """
)
```

### Architect Output: .spectre/design.md

This file becomes the IMPLEMENTATION CONTRACT:

```markdown
# Technical Design: Counter

## Overview
A delightful counter with persistence and theme support.

## Architecture Decision
Feature-folder structure with hexagonal architecture.
Domain logic isolated, React only in ui/ layer.

## File Structure

```
src/features/counter/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ Counter.ts              # Value object with increment/decrement
â”‚   â””â”€â”€ CounterError.ts         # Typed errors
â”œâ”€â”€ application/
â”‚   â””â”€â”€ useCounter.ts           # Hook returning Result<Counter, CounterError>
â”œâ”€â”€ infrastructure/
â”‚   â””â”€â”€ CounterStorage.ts       # localStorage adapter
â””â”€â”€ ui/
    â”œâ”€â”€ Counter.tsx             # Main component
    â”œâ”€â”€ Counter.test.tsx        # Tests
    â””â”€â”€ CounterButton.tsx       # Animated button
```

## Implementation Details

### File: src/features/counter/domain/Counter.ts
```typescript
// EXACT code structure Dev must follow
export type Counter = {
  readonly value: number;
};

export const Counter = {
  create: (value: number = 0): Counter => ({ value }),
  increment: (c: Counter): Counter => ({ value: c.value + 1 }),
  decrement: (c: Counter): Counter => ({ value: c.value - 1 }),
  reset: (): Counter => ({ value: 0 }),
};
```

### File: src/features/counter/application/useCounter.ts
```typescript
// Hook signature Dev must implement
export function useCounter(): {
  counter: Counter;
  increment: () => Result<Counter, CounterError>;
  decrement: () => Result<Counter, CounterError>;
  reset: () => void;
}
```

## Test Specifications (for QA)

- [ ] `Counter.test.ts`: "Counter.create returns Counter with value 0"
- [ ] `Counter.test.ts`: "Counter.increment increases value by 1"
- [ ] `Counter.test.ts`: "Counter.decrement decreases value by 1"
- [ ] `useCounter.test.ts`: "returns Ok on successful increment"
- [ ] `Counter.test.tsx`: "renders current value"
- [ ] `Counter.test.tsx`: "calls increment on + button click"

## Craft Checklist
- [ ] No `any` types
- [ ] Result<T, E> for operations that can fail
- [ ] Domain has no React imports
- [ ] Tests colocated with components
```

**Dev and QA implement THIS DOCUMENT. No improvisation.**

### Implementation Phases (from design.md)
    1. Phase 1: ...
    2. Phase 2: ...
  """
)
```

### Parallel Dev + QA Spawn

```
# Launch BOTH in parallel
Task(
  subagent_type: "frontend-engineer",
  run_in_background: true,
  prompt: """
    ARCHITECT DESIGN: <design>

    Implement the feature following the design.
    Write to .spectre/dev-progress.md as you complete each file.
  """
)

Task(
  subagent_type: "qa-engineer",
  run_in_background: true,
  prompt: """
    ACCEPTANCE CRITERIA: <from PO or architect>
    TEST SPECS: <from architect>

    Write tests for this feature.
    - Unit tests for domain logic
    - Integration tests for use cases
    - Component tests for UI

    Watch .spectre/dev-progress.md for completed files.
    Run tests as files become available.
    Write failures to .spectre/test-failures.md
  """
)

# Orchestrator monitors both and routes failures
```

---

## Context-Aware Routing Matrix

**Rule: All agents work from `.spectre/spec.md`. PO creates it if not provided.**

| Context | Input | PO Action | Pipeline |
|---------|-------|-----------|----------|
| **Product Team** | Text (any) | Creates full spec.md | PO â†’ Architect â†’ Dev â‡„ QA |
| **Product Team** | Jira/Linear ticket | Fetches + creates spec.md | PO â†’ Architect â†’ Dev â‡„ QA |
| **Product Team** | Spec file (.md/.yml) | Validates + copies | Architect â†’ Dev â‡„ QA |
| **Product Team** | Bug fix | â€” | Dev â†’ QA |
| **Startup** | Text (any) | Creates light spec.md | PO â†’ Architect â†’ Dev â‡„ QA |
| **Startup** | Spec file (.md/.yml) | Validates + copies | Architect â†’ Dev â‡„ QA |
| **Startup** | Bug fix | â€” | Dev â†’ QA |
| **Freelance** | Text (any) | Creates minimal spec.md | PO â†’ Dev â‡„ QA |
| **Freelance** | Spec file/Bug fix | â€” | Dev â†’ QA |
| **Learning** | Any | Explains while creating | Single agent |

**The spec.md is the contract. No spec = no work.**

---

## Example: Full Flow

```
User: /craft

ğŸ” No existing project detected.

"What stack?"
[ TypeScript + React ]

"What's your work context?"
[ Startup ]

"What do you want to build?"

User: a sexy counter

ğŸ“ Analyzing your input...

   Input type: Raw idea (informal, no specifics)
   Recommended flow: PO â†’ Architect â†’ Dev â‡„ QA

   The Product Owner will create a proper spec first.

[ Start ] [ Add more details ]

User: [ Start ]

ğŸ‘¤ Product Owner creating spec...

   ## User Story
   As a user, I want a visually appealing counter
   so that I can track values with delight.

   ## Acceptance Criteria
   - [ ] Display current value (default: 0)
   - [ ] Increment (+1) with micro-animation
   - [ ] Decrement (-1) with micro-animation
   - [ ] Reset to 0
   - [ ] Persist in localStorage
   - [ ] Dark/light theme toggle
   - [ ] Keyboard accessible (arrows, enter)
   - [ ] Smooth transitions

   ## Edge Cases
   - Allow negative values
   - No max limit

[ Approve spec ] [ Modify ]

User: [ Approve spec ]

ğŸ—ï¸ Architect designing...

   ## Architecture

   src/features/counter/
   â”œâ”€â”€ domain/
   â”‚   â””â”€â”€ Counter.ts         # Value + operations
   â”œâ”€â”€ application/
   â”‚   â””â”€â”€ useCounter.ts      # Hook with localStorage
   â”œâ”€â”€ infrastructure/
   â”‚   â””â”€â”€ CounterStorage.ts  # localStorage adapter
   â””â”€â”€ ui/
       â”œâ”€â”€ Counter.tsx        # Main component
       â”œâ”€â”€ Counter.test.tsx   # Tests
       â””â”€â”€ CounterButton.tsx  # Animated button

   ## For QA - Test Scenarios
   - renders with initial value 0
   - increments on + click
   - decrements on - click
   - resets to 0
   - persists to localStorage
   - loads from localStorage on mount
   - supports keyboard navigation

[ Approve design ] [ Modify ]

User: [ Approve design ]

ğŸš€ Starting parallel execution...

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ğŸ’» Dev implementing...                  â”‚
   â”‚  ğŸ§ª QA writing tests...                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Dev: âœ“ Created Counter.ts (domain)
   QA:  âœ“ Writing domain tests...

   Dev: âœ“ Created useCounter.ts
   QA:  âœ“ Writing hook tests...

   Dev: âœ“ Created Counter.tsx
   QA:  ğŸ§ª Running tests...

   QA:  âŒ FAIL: "should persist to localStorage"
        Expected localStorage.setItem to be called

   Dev: ğŸ”§ Fixing... added localStorage sync

   QA:  ğŸ§ª Re-running...
   QA:  âœ“ All tests passing (12/12)

âœ¨ Feature complete!

   Files: 6 created
   Tests: 12 passing
   Coverage: 94%
```

---

## State Storage

```json
// .spectre/state.json
{
  "workflow": "craft",
  "inputType": "raw_idea",
  "context": "startup",
  "phase": "parallel_execution",
  "agents": {
    "po": { "status": "complete", "output": "spec.md" },
    "architect": { "status": "complete", "output": "design.md" },
    "dev": { "status": "in_progress", "files": ["Counter.ts", "useCounter.ts"] },
    "qa": { "status": "in_progress", "tests": 12, "passing": 10, "failing": 2 }
  }
}
```

---

## Tone

- **Smart**: Detects input type, routes intelligently
- **Parallel**: Dev and QA work together, not sequentially
- **Reactive**: Failures route instantly to the right agent
- **Transparent**: User sees what's happening at each step
- **Adaptive**: Different flows for different contexts
