---
name: craft
description: "Craft something. Smart professional flow: spec first, then adapt. QA optional."
context: conversation
allowed-tools: Read, Bash, Task, AskUserQuestion, Glob, Grep, WebFetch, Write
---

# Spectre Craft â€” Professional Flow

**Learn first. Smart choices. Then build.**

---

## The Flow â€” Learning FIRST, Questions AFTER

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚   /craft                                                         â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚   â•‘  STEP 1: LEARNING (IMMEDIATE)                             â•‘ â”‚
â”‚   â•‘                                                           â•‘ â”‚
â”‚   â•‘  ğŸ“¦ Detecting stack...                                    â•‘ â”‚
â”‚   â•‘     â†’ typescript, react, fp-ts, zustand, zod, vitest     â•‘ â”‚
â”‚   â•‘                                                           â•‘ â”‚
â”‚   â•‘  ğŸ›ï¸ Architect generating library skills...                â•‘ â”‚
â”‚   â•‘     â†’ .spectre/stack-skills.md                           â•‘ â”‚
â”‚   â•‘                                                           â•‘ â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚   â•‘  STEP 2: SMART CHOICES (based on detected stack)          â•‘ â”‚
â”‚   â•‘                                                           â•‘ â”‚
â”‚   â•‘  "I detected: TypeScript + React + fp-ts + Zustand"       â•‘ â”‚
â”‚   â•‘                                                           â•‘ â”‚
â”‚   â•‘  What do you want to do?                                  â•‘ â”‚
â”‚   â•‘                                                           â•‘ â”‚
â”‚   â•‘  â€¢ âœ¨ New feature (I have a spec or idea)                â•‘ â”‚
â”‚   â•‘  â€¢ ğŸ› Fix a bug                                          â•‘ â”‚
â”‚   â•‘  â€¢ ğŸ’œ Improve existing code (CRAFT refactoring)          â•‘ â”‚
â”‚   â•‘      â””â”€ [contextual sub-options based on stack]          â•‘ â”‚
â”‚   â•‘         â€¢ Migrate to Result<T,E> with fp-ts              â•‘ â”‚
â”‚   â•‘         â€¢ Remove all `any` types                          â•‘ â”‚
â”‚   â•‘         â€¢ Restructure to hexagonal                        â•‘ â”‚
â”‚   â•‘         â€¢ Add missing tests                               â•‘ â”‚
â”‚   â•‘                                                           â•‘ â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   [Continue based on choice...]                                  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key insight: We know the stack BEFORE asking questions, so we can propose SMART options.**

---

## What The User Sees

**IMPACT. VISUAL. WAHOUUUU.**

```

   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
   â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘        â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
   â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘        â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•
   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
   â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•

   C R A F T   M O D E                    Stop prompting. Start crafting.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   â—ˆ LEARNING

   â–¸ Detecting stack...
     â ‹ Scanning package.json...

   âœ“ Stack detected
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  typescript â€¢ react â€¢ fp-ts â€¢ zustand â€¢ zod â€¢ vitest    â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â–¸ Architect generating library skills...
     â ¹ TypeScript: utility types, strict mode
     â ¸ React: hooks, composition, state
     â ¼ fp-ts: Option, Either, TaskEither, pipe
     â ´ Zustand: stores, selectors, middleware
     â ¦ Zod: schemas, safeParse, inference

   âœ“ Stack skills ready â†’ .spectre/stack-skills.md

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   â—ˆ WHAT DO YOU WANT TO DO?

   I detected: TypeScript + React + fp-ts + Zustand + Zod

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                                                             â”‚
   â”‚  [1] âœ¨ New feature          Build something new            â”‚
   â”‚  [2] ğŸ› Fix a bug            Something is broken            â”‚
   â”‚  [3] ğŸ’œ Improve existing     CRAFT refactoring              â”‚
   â”‚      â”œâ”€ ğŸ”„ Migrate to Result<T,E>  (you have fp-ts!)       â”‚
   â”‚      â”œâ”€ ğŸš« Remove all `any` types                          â”‚
   â”‚      â”œâ”€ ğŸ›ï¸ Restructure to hexagonal                        â”‚
   â”‚      â””â”€ ğŸ§ª Add missing tests                               â”‚
   â”‚  [4] ğŸ” Audit my code        Review quality & patterns      â”‚
   â”‚                                                             â”‚
   â”‚  Or type your own need...                                   â”‚
   â”‚                                                             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   â—ˆ PO â€” Functional Specification

   â–¸ Analyzing requirements...
   â–¸ Writing user stories...
   â–¸ Defining acceptance criteria...

   âœ“ Spec ready â†’ .spectre/specs/functional/spec-v1.md

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ğŸ“‹ SPEC SUMMARY                                            â”‚
   â”‚                                                             â”‚
   â”‚  Feature: Shopping Cart                                     â”‚
   â”‚  Stories: 4 user stories                                    â”‚
   â”‚  Criteria: 12 acceptance criteria                           â”‚
   â”‚                                                             â”‚
   â”‚  [Review spec] [Accept] [Request changes]                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   â—ˆ ARCHITECT â€” Technical Design

   â–¸ Reading CRAFT skills from .spectre/stack-skills.md
   â–¸ Applying hexagonal architecture...
   â–¸ Designing domain boundaries...
   â–¸ Defining Result<T,E> error types...

   âœ“ Design ready â†’ .spectre/specs/design/design-v1.md

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ğŸ›ï¸ ARCHITECTURE                                            â”‚
   â”‚                                                             â”‚
   â”‚  src/                                                       â”‚
   â”‚  â”œâ”€â”€ domain/         Pure TypeScript, no framework          â”‚
   â”‚  â”‚   â””â”€â”€ cart/       Cart entity + CartError type           â”‚
   â”‚  â”œâ”€â”€ application/    Use cases with Result<T,E>             â”‚
   â”‚  â”‚   â””â”€â”€ useAddToCart.ts                                    â”‚
   â”‚  â”œâ”€â”€ infrastructure/ External services                      â”‚
   â”‚  â””â”€â”€ ui/             React components (thin)                â”‚
   â”‚                                                             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   â—ˆ DEV + QA â€” Parallel Execution

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  âš¡ DEV                     â”‚  ğŸ§ª QA                         â”‚
   â”‚                            â”‚                                â”‚
   â”‚  â–¸ Implementing domain...  â”‚  â–¸ Setting up Playwright...   â”‚
   â”‚  â–¸ Writing cart.ts         â”‚  â–¸ Creating Page Objects...   â”‚
   â”‚  â–¸ Adding unit tests...    â”‚  â–¸ Writing e2e tests...       â”‚
   â”‚  âœ“ Implementation done     â”‚  âœ“ E2E tests done             â”‚
   â”‚                            â”‚                                â”‚
   â”‚  Files: 6 created          â”‚  Tests: 8 scenarios           â”‚
   â”‚  Tests: 12 unit tests      â”‚  Coverage: 100% of spec       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   â—ˆ VERIFICATION

   â–¸ Running npm run build...     âœ“ Build passed
   â–¸ Running npm test...          âœ“ 12/12 unit tests passed
   â–¸ Running npx playwright...    âœ“ 8/8 e2e tests passed
   â–¸ Running tsc --noEmit...      âœ“ No type errors

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   â—ˆ NOTIFICATION (if failures)

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  ğŸ”” QA â†’ DEV                                                â”‚
   â”‚                                                             â”‚
   â”‚  Test failed: cart.spec.ts:45                               â”‚
   â”‚  Expected: 100                                              â”‚
   â”‚  Received: null                                             â”‚
   â”‚                                                             â”‚
   â”‚  Issue in: src/domain/cart/cart.ts:getTotal()              â”‚
   â”‚                                                             â”‚
   â”‚  Please fix and notify back.                                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â–¸ Dev fixing...
   â–¸ Dev notifies: "âœ“ Fixed cart.ts, please re-test"
   â–¸ QA re-running tests...
   âœ“ All tests pass

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
   â”ƒ                                                             â”ƒ
   â”ƒ   âœ“ C R A F T   C O M P L E T E                            â”ƒ
   â”ƒ                                                             â”ƒ
   â”ƒ   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
   â”ƒ   â”‚  ğŸ“ FILES CREATED                                    â”‚  â”ƒ
   â”ƒ   â”‚                                                      â”‚  â”ƒ
   â”ƒ   â”‚  .spectre/specs/functional/spec-v1.md               â”‚  â”ƒ
   â”ƒ   â”‚  .spectre/specs/design/design-v1.md                 â”‚  â”ƒ
   â”ƒ   â”‚  src/domain/cart/cart.ts                            â”‚  â”ƒ
   â”ƒ   â”‚  src/domain/cart/cart.test.ts                       â”‚  â”ƒ
   â”ƒ   â”‚  src/domain/cart/cart.types.ts                      â”‚  â”ƒ
   â”ƒ   â”‚  src/application/useAddToCart.ts                    â”‚  â”ƒ
   â”ƒ   â”‚  src/ui/components/Cart.tsx                         â”‚  â”ƒ
   â”ƒ   â”‚  e2e/tests/cart/cart.spec.ts                        â”‚  â”ƒ
   â”ƒ   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ
   â”ƒ                                                             â”ƒ
   â”ƒ   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”ƒ
   â”ƒ   â”‚  ğŸ§ª TEST RESULTS                                     â”‚  â”ƒ
   â”ƒ   â”‚                                                      â”‚  â”ƒ
   â”ƒ   â”‚  Unit tests:    12 passed   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%      â”‚  â”ƒ
   â”ƒ   â”‚  E2E tests:      8 passed   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  100%      â”‚  â”ƒ
   â”ƒ   â”‚  Type check:     âœ“ clean                            â”‚  â”ƒ
   â”ƒ   â”‚  Build:          âœ“ success                          â”‚  â”ƒ
   â”ƒ   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”ƒ
   â”ƒ                                                             â”ƒ
   â”ƒ   Kent Beck â€¢ Uncle Bob â€¢ Martin Fowler â€¢ Eric Evans       â”ƒ
   â”ƒ   The craft masters approve. ğŸ¯                            â”ƒ
   â”ƒ                                                             â”ƒ
   â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›

```

---

## Step 1: Immediate Learning (NO questions first)

**As soon as `/craft` is called, run Learning Agent.**

```
Task(
  subagent_type: "learning-agent",
  prompt: """
    DETECT STACK AND GENERATE SKILLS

    1. Read package.json, tsconfig.json, go.mod, etc.
    2. Extract ALL libraries
    3. Write .spectre/context.json
    4. Spawn Architect to generate library skills
    5. Write .spectre/stack-skills.md

    OUTPUT:
    "ğŸ“¦ Detecting stack...
       â†’ <libraries>"
    "ğŸ›ï¸ Architect generating library skills...
       â†’ <lib>: <what>"
    "âœ… Stack skills ready"

    Return the detected stack for next step.
  """
)
```

---

## Step 2: Smart Contextual Choices

**Based on detected stack, propose intelligent options.**

**IMPORTANT: User can ALWAYS express a custom need via "Other".**

### Free Text = Smart Routing

When user types a custom need, interpret and route to the right CRAFT flow:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER INPUT                      SMART ROUTING                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                                  â”‚
â”‚  "Create e2e regression tests"   â†’ QA Agent (regression mode)   â”‚
â”‚  "Check my Tailwind is clean"    â†’ Architect Audit (Tailwind)   â”‚
â”‚  "Add dark mode"                 â†’ Feature flow (POâ†’Archâ†’Dev)   â”‚
â”‚  "Migrate to fp-ts"              â†’ Refactoring (Architect plan) â”‚
â”‚  "Just write unit tests"         â†’ Dev only (BDD tests)         â”‚
â”‚  "Review my code quality"        â†’ Architect Audit (full)       â”‚
â”‚  "Setup CI/CD"                   â†’ Architect (infra design)     â”‚
â”‚  "I don't know, help me"         â†’ Guided questions             â”‚
â”‚                                                                  â”‚
â”‚  ALWAYS RESPECT CRAFT:                                          â”‚
â”‚  â†’ Hexagonal architecture                                       â”‚
â”‚  â†’ Result<T, E> for errors                                      â”‚
â”‚  â†’ Strict TypeScript                                            â”‚
â”‚  â†’ BDD colocated tests                                          â”‚
â”‚  â†’ Domain isolation                                             â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Routing Logic

```
IF user_input contains "test" or "e2e" or "regression":
   â†’ QA Agent
   â†’ Mode: e2e | integration | regression

IF user_input contains "review" or "audit" or "check" or "clean":
   â†’ Architect Audit
   â†’ Focus: code quality | specific lib (Tailwind, etc.)

IF user_input contains "migrate" or "refactor" or "restructure":
   â†’ Architect Refactoring Plan
   â†’ Then Dev implements

IF user_input contains "add" or "create" or "build" or "implement":
   â†’ Feature Flow
   â†’ PO (if functional) â†’ Architect â†’ Dev â†’ QA

IF user_input contains "fix" or "bug" or "broken":
   â†’ Bug Fix Flow
   â†’ Architect diagnoses â†’ Dev fixes â†’ QA verifies

IF user_input is vague or "help":
   â†’ Continue with guided questions
```

### Example: Custom Input Handling

```
User: "I just want to create e2e regression tests for my app"

Response:
"Got it! You want regression tests.

ğŸ“¦ Stack detected: React + Vitest + Playwright

I'll launch QA Agent in regression mode:
â†’ Analyze existing functionality
â†’ Create characterization tests
â†’ Cover critical user flows

Where should tests go?
â€¢ ğŸ“¦ Default (e2e/)
â€¢ ğŸ“‚ Custom path
â€¢ ğŸ”— Different repo"
```

```
User: "Check my Tailwind code is properly organized"

Response:
"Got it! Tailwind audit.

ğŸ›ï¸ Architect will review:
â†’ Utility class usage
â†’ Component consistency
â†’ Dark mode patterns
â†’ Responsive breakpoints
â†’ Custom config

Launching Architect audit..."
```

```
User: "I want to add a shopping cart"

Response:
"Got it! New feature: Shopping Cart.

This needs the full flow:
â†’ ğŸ“‹ PO: Functional spec (user stories)
â†’ ğŸ›ï¸ Architect: Technical design (CRAFT)
â†’ âš¡ Dev: Implementation
â†’ ğŸ§ª QA: E2E tests

Do you have a spec or should PO create one?"
```

---

### If Project Exists (has package.json, src/, etc.)

```
AskUserQuestion(
  questions: [{
    question: "I detected: <STACK>. What do you want to do?",
    header: "Action",
    options: [
      { label: "âœ¨ New feature", description: "Build something new" },
      { label: "ğŸ› Fix a bug", description: "Something is broken" },
      { label: "ğŸ’œ Improve existing", description: "CRAFT refactoring" },
      { label: "ğŸ§ª Add tests", description: "E2E, integration, or unit tests" },
      { label: "ğŸ” Audit my code", description: "Review quality & patterns" }
    ]
    // User can ALWAYS type custom need via "Other"
  }]
)
```

### If "Improve existing" â†’ Contextual Sub-Options

**Options depend on what was detected:**

```
# If fp-ts detected
{ label: "ğŸ”„ Migrate to Result<T,E>", description: "Use fp-ts Either for error handling" }

# If TypeScript detected
{ label: "ğŸš« Remove `any` types", description: "Strict typing everywhere" }

# If Tailwind detected
{ label: "ğŸ¨ Clean up Tailwind", description: "Consistent utilities, proper patterns" }

# Always available
{ label: "ğŸ›ï¸ Restructure to hexagonal", description: "Domain/Application/Infrastructure" }
{ label: "ğŸ§ª Add missing tests", description: "BDD colocated tests" }
{ label: "âœ¨ Full CRAFT migration", description: "All of the above" }

// User can ALWAYS type custom need via "Other"
```

### If No Project (fresh start)

```
AskUserQuestion(
  questions: [{
    question: "No project detected. What stack?",
    header: "Stack",
    options: [
      { label: "âš›ï¸ React + TypeScript", description: "Frontend app with Vite" },
      { label: "ğŸŸ¢ Node + TypeScript", description: "Backend API" },
      { label: "ğŸ”¥ Full-stack", description: "React + Node monorepo" },
      { label: "ğŸ¹ Go", description: "Backend service" }
    ]
    // User can ALWAYS type custom stack via "Other"
  }]
)
```

Then run Learning Agent with the chosen stack.

---

## Full Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚   /craft                                                         â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚   â•‘  1. LEARNING (IMMEDIATE)                                  â•‘ â”‚
â”‚   â•‘     â†’ Detect stack                                        â•‘ â”‚
â”‚   â•‘     â†’ Architect generates library skills                  â•‘ â”‚
â”‚   â•‘     â†’ .spectre/context.json + stack-skills.md            â•‘ â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚       â”‚                                                          â”‚
â”‚       â–¼                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚   â”‚  2. SMART CHOICES (contextual)      â”‚                       â”‚
â”‚   â”‚     â†’ Options based on detected stackâ”‚                       â”‚
â”‚   â”‚     â†’ "New feature" / "Bug" / "Improve"                    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                     â”‚                                            â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚       â”‚             â”‚             â”‚                             â”‚
â”‚       â–¼             â–¼             â–¼                             â”‚
â”‚   NEW FEATURE    BUG FIX     IMPROVE EXISTING                   â”‚
â”‚       â”‚             â”‚             â”‚                             â”‚
â”‚       â–¼             â–¼             â”‚                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                             â”‚
â”‚   â”‚ 3. QA CONFIG        â”‚         â”‚                             â”‚
â”‚   â”‚    â†’ E2E? Integration?â”‚        â”‚                             â”‚
â”‚   â”‚    â†’ Same repo? Remote?â”‚       â”‚                             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚                             â”‚
â”‚              â”‚                    â”‚                             â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”             â”‚                             â”‚
â”‚       â”‚             â”‚             â”‚                             â”‚
â”‚       â–¼             â”‚             â–¼                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚    PO    â”‚      â”‚      â”‚ ARCHITECT AUDIT  â”‚                â”‚
â”‚   â”‚  spec    â”‚      â”‚      â”‚ (refactoring plan)â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚        â”‚            â”‚               â”‚                           â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜               â”‚                           â”‚
â”‚               â”‚                     â”‚                           â”‚
â”‚               â–¼                     â–¼                           â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚        â”‚ ARCHITECTâ”‚          â”‚   DEV    â”‚                      â”‚
â”‚        â”‚  design  â”‚          â”‚  refacto â”‚                      â”‚
â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚             â”‚                     â”‚                             â”‚
â”‚             â–¼                     â”‚                             â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚                             â”‚
â”‚        â”‚ DEV + QA â”‚               â”‚                             â”‚
â”‚        â”‚ (parallel)â”‚              â”‚                             â”‚
â”‚        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜               â”‚                             â”‚
â”‚             â”‚                     â”‚                             â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â–¼                                         â”‚
â”‚                  FIXING LOOP                                     â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â–¼                                         â”‚
â”‚                      DONE                                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### "Craft the existing" â€” CRAFT Refactoring (NO PO)

**When to use:**
- Migration to `Result<T, E>` (remove `throw`)
- Remove all `any` types
- Hexagonal restructure (domain/application/infrastructure)
- Colocate tests
- Clean code / SOLID
- Rename / reorganize

**What changes:**
- âŒ No PO (no functional change)
- âœ… Architect (CRAFT design)
- âœ… Dev (implementation)
- âœ… QA (regression tests â€” ensure nothing breaks)

**Functionality stays the same. Only code quality improves.**

---

## Step 0: Detect Project

**ALWAYS check this first.**

```bash
# Auto-detect stack
if [ -f "package.json" ] || [ -f "go.mod" ] || [ -f "Cargo.toml" ]; then
  PROJECT_EXISTS=true
  STACK=$(detect_stack)
else
  PROJECT_EXISTS=false
fi
```

---

## Step 1: What Do You Want? (If Project Exists)

**If project detected â†’ Ask intent FIRST.**

```
AskUserQuestion(
  questions: [{
    question: "ğŸ”® Project detected ($STACK). What do you want to do?",
    header: "Intent",
    options: [
      { label: "ğŸ’œ Craft the existing", description: "CRAFT refactoring â€” no functional change" },
      { label: "âœ¨ New feature", description: "Add new functionality" },
      { label: "ğŸ› Fix a bug", description: "Something's broken" },
      { label: "â™»ï¸ Other refactor", description: "Refactoring with functional changes" }
    ]
  }]
)
```

### If "ğŸ’œ Craft the existing" â†’ SKIP PO

```
# No spec needed â€” pure technical refactoring
# Go directly to Architect â†’ Dev â†’ QA (regression)
SKIP_PO=true
```

### Otherwise â†’ Ask for Spec

```
# Need functional spec
SKIP_PO=false
# Continue to Step 2
```

---

## Step 1b: Stack? (If No Project)

**If no project â†’ Ask stack, then spec.**

```
AskUserQuestion(
  questions: [{
    question: "ğŸ”® What's your stack?",
    header: "Stack",
    options: [
      { label: "âš›ï¸ React + TypeScript", description: "Frontend app" },
      { label: "ğŸŸ¢ Node + TypeScript", description: "Backend API" },
      { label: "ğŸ”¥ Full-stack TS", description: "React + Node monorepo" },
      { label: "ğŸ¹ Go", description: "Backend service" }
    ]
  }]
)
```

Then continue to Step 2 (Spec).

---

## Step 2: Do You Have a Spec?

**Only ask if NOT "Crafter l'existant".**

```
AskUserQuestion(
  questions: [{
    question: "ğŸ“‹ Do you have a spec or requirements?",
    header: "Spec",
    options: [
      { label: "âœ… Yes, I have one", description: "File, Jira, Notion, or I'll paste it" },
      { label: "ğŸ’¡ No, just an idea", description: "Let's build the spec together" }
    ]
  }]
)
```

---

## Step 3a: If Has Spec â†’ Where Is It?

```
AskUserQuestion(
  questions: [{
    question: "ğŸ“ Where's the spec?",
    header: "Source",
    options: [
      { label: "ğŸ“ Local file", description: "I'll give you the path" },
      { label: "ğŸ”— URL / Ticket", description: "Jira, Linear, GitHub, Notion..." },
      { label: "ğŸ“ Paste it", description: "I'll copy-paste it here" }
    ]
  }]
)
```

Then:
- **Local file** â†’ Ask for path, read file
- **Jira/Linear/GitHub** â†’ Ask for URL/ID, fetch content
- **Paste** â†’ Ask user to paste

---

## Step 3b: If No Spec â†’ Describe It

Ask for details (free text):

```
ğŸ’¬ Describe what you want to build:
> [user describes the feature/fix]
```

---

## Step 3c: QA Configuration (UPFRONT)

**Ask QA preferences BEFORE launching the chain. This enables Dev + QA in parallel.**

```
AskUserQuestion(
  questions: [{
    question: "ğŸ§ª Do you want QA tests (E2E/Integration)?",
    header: "QA",
    options: [
      { label: "âœ… Yes, with QA", description: "E2E or Integration tests (Recommended)" },
      { label: "â­ï¸ No, Dev only", description: "Unit tests only (colocated)" }
    ]
  }]
)
```

### If "Yes, with QA" â†’ Ask Test Type + Location

```
AskUserQuestion(
  questions: [
    {
      question: "ğŸ§ª What type of tests?",
      header: "Tests",
      options: [
        { label: "ğŸ­ E2E (Playwright)", description: "Full browser tests" },
        { label: "ğŸ”Œ Integration", description: "API boundary tests" }
      ]
    },
    {
      question: "ğŸ“ Where to store tests?",
      header: "Location",
      options: [
        { label: "ğŸ“¦ Same repo (default path)", description: "e2e/ or tests/integration/ at root" },
        { label: "ğŸ“‚ Same repo (custom path)", description: "I'll specify the folder" },
        { label: "ğŸ”— Different repo", description: "Separate test repository" }
      ]
    }
  ]
)
```

### Test Location Options

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 TEST LOCATION OPTIONS                            â”‚
â”‚                                                                  â”‚
â”‚   Option A: Same repo, default path                              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚   project/                                                       â”‚
â”‚   â”œâ”€â”€ src/              â† App code (NO tests here)              â”‚
â”‚   â”œâ”€â”€ e2e/              â† E2E tests (default)                   â”‚
â”‚   â””â”€â”€ tests/                                                     â”‚
â”‚       â””â”€â”€ integration/  â† Integration tests (default)           â”‚
â”‚                                                                  â”‚
â”‚   Option B: Same repo, custom path                               â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚   User specifies: "packages/tests/e2e"                          â”‚
â”‚   project/                                                       â”‚
â”‚   â”œâ”€â”€ src/                                                       â”‚
â”‚   â””â”€â”€ packages/                                                  â”‚
â”‚       â””â”€â”€ tests/                                                 â”‚
â”‚           â””â”€â”€ e2e/      â† Custom location                       â”‚
â”‚                                                                  â”‚
â”‚   Option C: Different repo                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚   project/              project-tests/ (separate repo)          â”‚
â”‚   â””â”€â”€ src/              â””â”€â”€ e2e/                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### If "Same repo (custom path)" â†’ Ask Path

```
# User provides local path
# Example: "packages/e2e" or "test/e2e"
```

### If "Different repo" â†’ Ask for Remote URL

```
# User provides git remote URL
# Example: git@github.com:org/project-tests.git
```

### Store QA Config

```
QA_CONFIG = {
  enabled: true | false,
  type: "e2e" | "integration",
  location: "same-default" | "same-custom" | "different",
  local_path: "e2e/" | "tests/integration/" | "<custom>",
  remote_url: "<url>" | null
}

# Default paths (at project ROOT, not in src/)
# E2E: e2e/
# Integration: tests/integration/
```

**This config is used in Step 6 to launch Dev + QA in parallel (if enabled).**

---

## BRANCH A: "Craft the existing" (NO PO)

**Pure technical refactoring â€” functional behavior unchanged.**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 ğŸ’œ CRAFT THE EXISTING                            â”‚
â”‚                                                                  â”‚
â”‚   âŒ PO (skipped â€” no functional change)                        â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Q: "What do you want to craft?"                          â”‚  â”‚
â”‚   â”‚                                                          â”‚  â”‚
â”‚   â”‚ â€¢ ğŸš« Remove all `any` types                              â”‚  â”‚
â”‚   â”‚ â€¢ ğŸ”„ Migrate to Result<T, E>                             â”‚  â”‚
â”‚   â”‚ â€¢ ğŸ›ï¸ Restructure to hexagonal                            â”‚  â”‚
â”‚   â”‚ â€¢ ğŸ§ª Add colocated tests                                 â”‚  â”‚
â”‚   â”‚ â€¢ âœ¨ Full CRAFT migration                                â”‚  â”‚
â”‚   â”‚ â€¢ ğŸ“ Other (describe)                                    â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚   â•‘              LEARNING AGENT (MANDATORY)                   â•‘  â”‚
â”‚   â•‘   â€¢ Detect stack â†’ context.json                          â•‘  â”‚
â”‚   â•‘   â€¢ Generate CRAFT skills â†’ stack-skills.md              â•‘  â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                          â”‚                                       â”‚
â”‚                          â–¼                                       â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚                   â”‚ Architectâ”‚ â†’ Refactoring plan               â”‚
â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   (uses stack skills + patterns) â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â–¼                                         â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚                   â”‚   Dev    â”‚ â†’ Apply changes + Unit tests     â”‚
â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                        â”‚                                         â”‚
â”‚                        â–¼                                         â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚                   â”‚    QA    â”‚ â†’ REGRESSION TESTS               â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   (ensure nothing broke)         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ask Craft Target

```
AskUserQuestion(
  questions: [{
    question: "ğŸ’œ What do you want to craft?",
    header: "Craft",
    options: [
      { label: "ğŸš« Remove `any`", description: "Strict TypeScript everywhere" },
      { label: "ğŸ”„ Result<T, E>", description: "Replace throw with Result types" },
      { label: "ğŸ›ï¸ Hexagonal", description: "Restructure domain/application/infra" },
      { label: "âœ¨ Full CRAFT", description: "Everything at once â€” the full monty" }
    ]
  }]
)
```

### Learning Agent (Before Architect)

```
Task(
  subagent_type: "learning-agent",
  prompt: """
    MODE: CRAFT THE EXISTING (pre-refactoring scan)

    ## Your Mission
    1. DETECT stack â†’ .spectre/context.json
    2. PREPARE stack skills â†’ .spectre/stack-skills.json
    3. LEARN project patterns â†’ .spectre/learnings/patterns.json
    4. Violations will be fixed by refactoring (don't block)

    ## Output
    Context and skills ready for Architect.
  """
)
```

### Architect for Refactoring

```
Task(
  subagent_type: "architect",
  prompt: """
    MODE: CRAFT THE EXISTING (pure technical refactoring)

    CRAFT TARGET: <selected option>
    STACK CONTEXT: .spectre/context.json
    STACK SKILLS: .spectre/stack-skills.json
    PROJECT PATTERNS: .spectre/learnings/patterns.json

    ## Your Job
    1. READ injected context from Learning Agent
    2. Analyze current codebase
    3. Identify all violations of CRAFT target
    4. Create refactoring plan in .spectre/specs/design/refacto-v1.md

    ## Output Format
    ```markdown
    ---
    version: "1.0.0"
    type: refactoring
    target: <craft target>
    ---

    # Refactoring Plan: <target>

    ## Current State
    - X files with `any`
    - Y functions throwing exceptions
    - Z files outside hexagonal structure

    ## Changes

    ### File: src/path/to/file.ts
    - [ ] Change: <description>
    - [ ] Before: <code snippet>
    - [ ] After: <code snippet>

    (repeat for each file)

    ## Order of Operations
    1. First: ...
    2. Then: ...
    3. Finally: ...

    ## Regression Risk
    - Low/Medium/High
    - Areas to test: ...
    ```

    ## IMPORTANT
    - NO functional changes
    - Behavior must remain identical
    - Only structure/types/patterns change
  """
)
```

### QA for Regression

**QA in refactoring mode: ensure NOTHING BROKE.**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 QA REGRESSION FLOW                              â”‚
â”‚                                                                  â”‚
â”‚   1. CHECK: Existing tests?                                      â”‚
â”‚        â”‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                                   â”‚
â”‚   â”‚         â”‚                                                   â”‚
â”‚  YES       NO                                                    â”‚
â”‚   â”‚         â”‚                                                   â”‚
â”‚   â–¼         â–¼                                                   â”‚
â”‚  RUN      WRITE                                                  â”‚
â”‚  existing "characterization tests"                               â”‚
â”‚  suite    (capture current behavior)                             â”‚
â”‚   â”‚         â”‚                                                   â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                   â”‚
â”‚        â”‚                                                         â”‚
â”‚   2. AFTER REFACTORING: Run all tests                           â”‚
â”‚        â”‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                                   â”‚
â”‚   â”‚         â”‚                                                   â”‚
â”‚  PASS     FAIL = REGRESSION â†’ Dev fixes                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```
Task(
  subagent_type: "qa-engineer",
  prompt: """
    MODE: REGRESSION TESTING (Craft the existing)

    ## Step 1: Check Existing Tests

    Find existing test files:
    - *.test.ts, *.spec.ts
    - e2e/, tests/integration/

    ## Step 2a: If Tests Exist â†’ Run as Baseline

    Run ALL existing tests BEFORE refactoring.
    Store results as baseline.
    After refactoring: run again, compare.

    ## Step 2b: If No Tests â†’ Write Characterization Tests

    Characterization tests capture CURRENT behavior:
    - Snapshot API responses
    - Snapshot service outputs
    - Document error handling
    - Capture edge case behaviors

    Location: tests/characterization/

    Example:
    ```typescript
    describe('UserService (Characterization)', () => {
      it('getUser returns this structure', async () => {
        const user = await service.getUser('123');
        expect(user).toMatchSnapshot();
      });
    });
    ```

    ## Step 3: After Refactoring

    Run ALL tests (existing + characterization).
    ANY failure = REGRESSION = Dev must fix.

    ## Output
    - .spectre/regression-report.md
    - List regressions â†’ triggers fixing loop

    ## Key Rule
    Behavior must NOT change. Same input = same output.
  """
)
```

---

## BRANCH B: Full Flow (WITH PO)

**Auto-detect first. Ask only if empty.**

```bash
# Check for project
if [ -f "package.json" ]; then
  # Read and detect: React? Node? Both?
  STACK=$(detect_from_package_json)
elif [ -f "go.mod" ]; then
  STACK="go"
elif [ -f "Cargo.toml" ]; then
  STACK="rust"
else
  # No project â†’ must ask
  ASK_STACK=true
fi
```

If `ASK_STACK`:
```
AskUserQuestion(
  questions: [{
    question: "ğŸ”® What's your stack?",
    header: "Stack",
    options: [
      { label: "âš›ï¸ React + TypeScript", description: "Frontend app" },
      { label: "ğŸŸ¢ Node + TypeScript", description: "Backend API" },
      { label: "ğŸ”¥ Full-stack TS", description: "React + Node monorepo" },
      { label: "ğŸ¹ Go", description: "Backend service" }
    ]
  }]
)
```

---

## Step 4: PO â€” ALWAYS RUNS (with User Validation)

**VERSION IS THE KEY. NEVER modify originals.**

```
.spectre/specs/
â”œâ”€â”€ functional/           # PO's domain
â”‚   â”œâ”€â”€ spec-v1.md        # version: 1.0.0 â€” IMMUTABLE
â”‚   â”œâ”€â”€ spec-v2.md        # version: 2.0.0 â€” PO improvements
â”‚   â””â”€â”€ ...               # History preserved forever
â””â”€â”€ design/               # Architect's domain (Step 5)
    â””â”€â”€ ...
```

### First: Check for Existing Specs

```bash
# If project already has specs, find latest version
ls .spectre/specs/functional/spec-v*.md 2>/dev/null | sort -V | tail -1
```

### If User Provided Spec (or Existing Project)

```
Task(
  subagent_type: "product-owner",
  prompt: """
    USER PROVIDED SPEC (raw input):
    <spec content â€” ANY format: paste, file, Jira, vague idea...>

    EXISTING SPECS (if any):
    <list of spec-vN.md files>

    ## MANDATORY STEP 1: Transform to Standard Format

    BEFORE anything else, transform user input into standard format:

    1. Create .spectre/specs/functional/ folder
    2. Find latest version N (or 0 if none)
    3. TRANSFORM user input into spec-v(N+1).md:

       ---
       version: "(N+1).0.0"
       status: draft
       author: user
       created: <today>
       parent: "spec-vN.md" | null
       feature: <slug>
       ---

       # Spec: [Title]

       > One-line summary

       ## Problem
       [Extract from user input or ask]

       ## User Story
       As a [persona], I want [goal], So that [benefit].

       ## Acceptance Criteria
       ### Happy Path
       - [ ] Given... When... Then...
       ### Edge Cases
       - [ ] Given... When... Then...
       ### Error Cases
       - [ ] Given... When... Then...

       ## Business Rules
       ## Out of Scope
       ## Changelog

    ## MANDATORY STEP 2: Review for CRAFT Compliance

    Check the TRANSFORMED spec against CRAFT checklist.
    If NOT compliant â†’ Create spec-v(N+2).md with improvements.

    ## IMMUTABILITY RULE
    - NEVER modify any existing spec-vN.md
    - Always create NEW version file

    ## Output
    - .spectre/specs/functional/spec-vN.md (STANDARDIZED, with frontmatter)
    - User validates before Architect starts

    NO RAW USER INPUT GOES TO ARCHITECT. EVER.
  """
)
```

### After PO Review â†’ Diff Approval (if major changes)

**If major changes needed, PO generates a diff file first.**

```
# PO generates diff file
.spectre/specs/functional/spec-v1-to-v2.diff.md

# Contains:
# - Summary of changes
# - ğŸ”´ MISSING (what must be added)
# - ğŸŸ¢ ADDED (what PO added)
# - ğŸŸ¡ MODIFIED (what changed)
# - WHY each change (CRAFT reason)
# - CRAFT compliance table (v1 vs v2)
```

**Then ask user to approve:**

```
AskUserQuestion(
  questions: [{
    question: "ğŸ”® PO improved your spec. Accept changes?",
    header: "Review",
    options: [
      { label: "ğŸ’œ Accept v2", description: "Looks good, let's roll" },
      { label: "ğŸš« Keep v1", description: "Use my original (may cause issues)" },
      { label: "ğŸ’¬ Discuss", description: "I have questions" }
    ]
  }]
)
```

### If User Gave Idea (No Spec)

```
Task(
  subagent_type: "product-owner",
  prompt: """
    USER WANTS: <user's description>
    TYPE: <feature/fix/refactor>

    ## Your Job
    Create a CRAFT-compliant functional spec.

    ## IMPORTANT
    - 100% FUNCTIONAL â€” no technical details
    - No stack, no architecture, no patterns
    - Focus on WHAT user wants, not HOW to build it

    ## Output: .spectre/specs/spec-v1.md

    Format:
    ```markdown
    # Spec: [Title]

    **Version:** v1
    **Status:** Draft
    **Author:** PO
    **Date:** <today>

    ---

    > [One-line user benefit]

    ## Problem
    [User problem we're solving]

    ## User Story
    As a [persona],
    I want [goal],
    So that [benefit].

    ## Acceptance Criteria

    ### Happy Path
    - [ ] Given [context], when [action], then [result]

    ### Edge Cases
    - [ ] Given [edge], when [action], then [behavior]

    ### Error Cases
    - [ ] Given [error], when [action], then [handling]

    ## Business Rules
    - [Rule 1]

    ## Out of Scope
    - [What we're NOT doing]

    ## Success Metrics
    - [How we measure success]
    ```

    Then ASK USER to validate before proceeding.
  """
)
```

### User Validates Spec

```
AskUserQuestion(
  questions: [{
    question: "ğŸ”® Spec ready. Ship it?",
    header: "Validate",
    options: [
      { label: "ğŸ’œ Let's go!", description: "Proceed to Architect" },
      { label: "âœï¸ Needs tweaks", description: "I want to adjust something" }
    ]
  }]
)

# If approved â†’ mark spec status: approved â†’ proceed to Learning Agent
# If changes needed â†’ PO creates new version (NEVER modify original)
```

---

## Step 4.5: Learning Agent â€” ALWAYS RUNS (Before Architect)

**Learning Agent detects stack, injects skills to Architect, checks violations.**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚   PO approved spec (or "Craft the existing" mode)               â”‚
â”‚        â”‚                                                         â”‚
â”‚        â–¼                                                         â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚   â•‘              LEARNING AGENT (MANDATORY)                   â•‘  â”‚
â”‚   â•‘                                                           â•‘  â”‚
â”‚   â•‘   1. Detect stack â†’ .spectre/context.json                 â•‘  â”‚
â”‚   â•‘   2. Generate CRAFT skills â†’ .spectre/stack-skills.md     â•‘  â”‚
â”‚   â•‘                                                           â•‘  â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚        â”‚                                                         â”‚
â”‚        â–¼                                                         â”‚
â”‚   ARCHITECT (reads stack-skills.md before designing)            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Learning Agent â€” Explicit Output

**The user MUST see this progress:**

```
ğŸ“š LEARNING

ğŸ“¦ Detecting stack...
   â†’ Found: package.json, tsconfig.json
   â†’ Libraries: typescript, react, zustand, zod, fp-ts, vitest

ğŸ›ï¸ Architect generating library skills...
   â†’ TypeScript: utility types, type guards
   â†’ React: hooks, composition
   â†’ fp-ts: Option, Either, pipe, flow
   â†’ Zustand: stores, selectors
   â†’ Zod: schemas, parsing
   â†’ Vitest: describe, expect, mocking

âœ… Stack skills ready
   â†’ .spectre/context.json
   â†’ .spectre/stack-skills.md

Architect will use for design.
```

### Learning Agent Task

```
Task(
  subagent_type: "learning-agent",
  prompt: """
    DETECT STACK AND GENERATE LIBRARY SKILLS

    ## Step 1: Detect Stack

    Read package.json dependencies.
    Extract ALL libraries (not just frameworks).

    Write .spectre/context.json:
    {
      "stack": {
        "language": "typescript",
        "libraries": ["react", "zustand", "zod", "fp-ts", "vitest", ...]
      }
    }

    OUTPUT TO USER:
    "ğŸ“¦ Detecting stack...
       â†’ Libraries: <list>"

    ## Step 2: Spawn Architect for Skills

    Task(
      subagent_type: "architect",
      prompt: "Generate library documentation for: <detected libs>.
               Write API, patterns, examples for EACH library.
               Output to .spectre/stack-skills.md.
               DON'T include CRAFT patterns (you already know them).
               DON'T analyze existing code (it might be garbage)."
    )

    OUTPUT TO USER:
    "ğŸ›ï¸ Architect generating library skills...
       â†’ <lib1>: <what>
       â†’ <lib2>: <what>"

    ## Step 3: Report Complete

    OUTPUT TO USER:
    "âœ… Stack skills ready
       â†’ .spectre/stack-skills.md

       Architect will use for design."
  """
)
```

---

## Step 5: Architect â€” ALWAYS RUNS

**Architect creates versioned design in `.spectre/specs/design/`**

```
Task(
  subagent_type: "architect",
  prompt: """
    FUNCTIONAL SPEC: .spectre/specs/functional/spec-vN.md (latest approved)
    STACK CONTEXT: .spectre/context.json (from Learning Agent)
    STACK SKILLS: .spectre/stack-skills.json (injected by Learning Agent)
    PROJECT PATTERNS: .spectre/learnings/patterns.json (from Learning Agent)

    ## IMPORTANT: Read Injected Context First
    1. READ .spectre/context.json for detected stack
    2. READ .spectre/stack-skills.json for stack-specific patterns
    3. READ .spectre/learnings/patterns.json for project conventions

    ## Your Job
    1. Find latest approved functional spec
    2. Check for existing designs in .spectre/specs/design/
    3. Apply BOTH built-in CRAFT AND stack-specific skills
    4. Follow project-specific conventions (naming, folders, imports)
    5. Create design-v(M+1).md with frontmatter:
       ---
       version: "(M+1).0.0"
       status: draft
       author: architect
       created: <today>
       parent: "design-vM.md" | null
       based_on: "spec-vN.md"
       feature: <slug>
       ---

    ## IMMUTABILITY RULE
    - NEVER modify existing design-vM.md
    - Design flaw found? Create design-v(M+1).md
    - Spec updated? Create design-v(M+1).md with new based_on

    ## CRAFT Rules (Mandatory)
    - Strict TypeScript (no any)
    - Result<T, E> for errors (no throw)
    - Domain at center (hexagonal)
    - Tests colocated

    ## Output: .spectre/specs/design/design-vN.md

    Format:
    ```markdown
    ---
    version: "1.0.0"
    based_on: "spec-v2.md"
    ...
    ---

    # Design: [Title]

    ## Approach
    [Brief technical approach]

    ## File Structure
    ```
    src/
    â””â”€â”€ features/
        â””â”€â”€ <feature>/
            â”œâ”€â”€ domain/
            â”‚   â””â”€â”€ [files]
            â”œâ”€â”€ application/
            â”‚   â””â”€â”€ [files]
            â”œâ”€â”€ infrastructure/
            â”‚   â””â”€â”€ [files]
            â””â”€â”€ ui/
                â””â”€â”€ [files]
    ```

    ## Implementation

    ### [File path]
    - Purpose: ...
    - Exports: ...
    - Pattern: Result<T, E>

    ## Tests
    - [ ] "[test 1]"
    - [ ] "[test 2]"

    ## CRAFT Checklist
    - [ ] No any
    - [ ] Result<T, E> for errors
    - [ ] Domain isolated
    - [ ] Tests colocated
    ```

    Dev and QA implement this EXACTLY.
  """
)
```

---

## Step 6: Dev + QA â€” PARALLEL EXECUTION + FIXING LOOP

**QA config was set in Step 3c. Now execute based on that config.**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 6: IMPLEMENTATION                        â”‚
â”‚                                                                  â”‚
â”‚   QA_CONFIG from Step 3c                                         â”‚
â”‚        â”‚                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”                                                   â”‚
â”‚   â”‚         â”‚                                                   â”‚
â”‚  ENABLED   DISABLED                                              â”‚
â”‚   â”‚         â”‚                                                   â”‚
â”‚   â–¼         â–¼                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   DEV    â•‘      QA      â”‚  â”‚        DEV ONLY         â”‚      â”‚
â”‚  â”‚          â•‘   (PARALLEL) â”‚  â”‚                         â”‚      â”‚
â”‚  â”‚  Code +  â•‘   E2E or     â”‚  â”‚  Code + Unit tests      â”‚      â”‚
â”‚  â”‚  Unit    â•‘   Integrationâ”‚  â”‚  (BDD colocated)        â”‚      â”‚
â”‚  â”‚  tests   â•‘              â”‚  â”‚                         â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â•¨â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚            â”‚                      â”‚                     â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                      â”‚                     â”‚
â”‚              â”‚                            â”‚                     â”‚
â”‚              â–¼                            â–¼                     â”‚
â”‚         FIXING LOOP                   FIXING LOOP               â”‚
â”‚         (Dev + QA)                    (Dev only)                â”‚
â”‚              â”‚                            â”‚                     â”‚
â”‚              â–¼                            â–¼                     â”‚
â”‚            DONE                         DONE                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Branch A: QA Disabled â†’ Dev Only

```
Task(
  subagent_type: "frontend-engineer",  # or backend-engineer
  prompt: """
    SPEC: .spectre/specs/functional/spec-vN.md
    DESIGN: .spectre/specs/design/design-vN.md

    ## Your Job
    Implement EXACTLY what design specifies.
    CRAFT: strict TS, Result<T,E>, domain isolated.

    ## Unit Tests (BDD)
    - Colocated *.test.ts next to source
    - Test domain logic, pure functions
    - Given-When-Then format

    ## Output
    - Implementation files
    - Unit tests (colocated)
    - .spectre/dev-status.md
  """
)

# Run unit tests
# If failures â†’ Dev fixes (loop)
# Until all green â†’ DONE
```

### Branch B: QA Enabled â†’ Dev + QA in Parallel

**PARALLEL EXECUTION: Both agents work simultaneously.**

```
# PARALLEL â€” Launch both at the same time
Task(
  subagent_type: "frontend-engineer",
  prompt: """
    SPEC: .spectre/specs/functional/spec-vN.md
    DESIGN: .spectre/specs/design/design-vN.md

    Implement + Unit tests (BDD colocated).
  """
)

Task(
  subagent_type: "qa-engineer",
  prompt: """
    MODE: <QA_CONFIG.type>  # e2e or integration
    SPEC: .spectre/specs/functional/spec-vN.md
    REPO: <QA_CONFIG.repo>  # same or different
    REMOTE: <QA_CONFIG.remote_url>  # if different repo

    ## If Same Repo
    Write tests in e2e/ or tests/integration/

    ## If Different Repo
    1. Clone: git clone <remote> .spectre/test-repo/
    2. Branch: git checkout -b feat/<feature>
    3. Write tests in .spectre/test-repo/
    4. Commit + push to remote

    ## Coverage
    100% of acceptance criteria from spec.
  """
)
```

### Test Repository Options

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 TEST REPOSITORY OPTIONS                          â”‚
â”‚                                                                  â”‚
â”‚   Option A: Same Repo (default)                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚   project/                                                       â”‚
â”‚   â”œâ”€â”€ src/                                                       â”‚
â”‚   â”œâ”€â”€ e2e/              â† E2E tests here                        â”‚
â”‚   â””â”€â”€ tests/integration/ â† Integration tests here               â”‚
â”‚                                                                  â”‚
â”‚   Option B: Different Repo                                       â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚   project/              project-tests/ (cloned)                  â”‚
â”‚   â”œâ”€â”€ src/              â”œâ”€â”€ e2e/                                â”‚
â”‚   â””â”€â”€ ...               â”œâ”€â”€ integration/                        â”‚
â”‚                         â””â”€â”€ playwright.config.ts                â”‚
â”‚                                                                  â”‚
â”‚   QA workflow for different repo:                                â”‚
â”‚   1. Clone to .spectre/test-repo/                               â”‚
â”‚   2. Create feature branch                                       â”‚
â”‚   3. Write tests                                                 â”‚
â”‚   4. Commit + push to test remote                                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After Parallel Execution â†’ Fixing Loop

```
# PARALLEL EXECUTION
Task(
  subagent_type: "frontend-engineer",  # or backend
  prompt: """
    SPEC: .spectre/specs/spec-latest.md
    DESIGN: .spectre/design.md

    Implement EXACTLY what design.md specifies.
    CRAFT: strict TS, Result<T,E>, domain isolated.

    UNIT TESTS (BDD):
    - Write colocated tests (*.test.ts next to source)
    - Test domain logic, pure functions
    - Given-When-Then format

    OUTPUT:
    - Implementation files
    - .spectre/dev-status.md with list of files created
  """
)

Task(
  subagent_type: "qa-engineer",
  prompt: """
    SPEC: .spectre/specs/spec-latest.md
    DESIGN: .spectre/design.md
    TEST TYPE: <E2E or Integration>

    ## Your Job
    - NEVER write unit tests (that's Dev's job)
    - Write <E2E/Integration> tests for ALL acceptance criteria
    - Run tests and report results

    ## Output
    - .spectre/test-coverage.md (100% spec coverage required)
    - .spectre/failures.md (if ANY test fails)
  """
)
```

---

## Step 7: REACTIVE NOTIFICATION LOOP (CORE OF SPECTRE)

**AGENTS NOTIFY EACH OTHER. THIS IS THE HEART OF THE SYSTEM.**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚              ğŸ”” INTER-AGENT NOTIFICATION SYSTEM                  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   DEV   â”‚â—„â”€â”€â–ºâ”‚   QA    â”‚â—„â”€â”€â–ºâ”‚  ARCH   â”‚â—„â”€â”€â–ºâ”‚   PO    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚              â”‚              â”‚              â”‚            â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                          â”‚                                       â”‚
â”‚                    NOTIFICATION BUS                              â”‚
â”‚                                                                  â”‚
â”‚  Example notifications:                                          â”‚
â”‚                                                                  â”‚
â”‚  QA â†’ DEV:   "ğŸ”´ Test failed: src/cart.ts:45 returns null"      â”‚
â”‚  DEV â†’ QA:   "âœ… Fixed cart.ts, please re-test"                 â”‚
â”‚  BUILD â†’ DEV: "ğŸ”´ Build error: Cannot find module './utils'"    â”‚
â”‚  DEV â†’ ARCH: "â“ Type issue, need design clarification"         â”‚
â”‚  ARCH â†’ DEV: "ğŸ“ Updated design, re-implement checkout()"       â”‚
â”‚  QA â†’ PO:    "â“ Spec unclear: what happens on empty cart?"     â”‚
â”‚  PO â†’ QA:    "ğŸ“‹ Spec updated, empty cart shows message"        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### How Notifications Work

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚  1. ERROR DETECTED                                               â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  2. IDENTIFY OWNER (who wrote this code?)                        â”‚
â”‚     â”‚                                                            â”‚
â”‚     â”œâ”€ src/**      â†’ Dev owns it                                â”‚
â”‚     â”œâ”€ e2e/**      â†’ QA owns it                                 â”‚
â”‚     â”œâ”€ design      â†’ Architect owns it                          â”‚
â”‚     â””â”€ spec        â†’ PO owns it                                 â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  3. NOTIFY OWNER with context                                    â”‚
â”‚     â”‚                                                            â”‚
â”‚     â”‚  Task(subagent: "<owner>", prompt: """                    â”‚
â”‚     â”‚    ğŸ”” NOTIFICATION FROM <sender>                          â”‚
â”‚     â”‚                                                            â”‚
â”‚     â”‚    Error: <description>                                    â”‚
â”‚     â”‚    File: <path>:<line>                                    â”‚
â”‚     â”‚    Context: <what was happening>                          â”‚
â”‚     â”‚                                                            â”‚
â”‚     â”‚    Please fix and notify back when done.                  â”‚
â”‚     â”‚  """)                                                      â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  4. OWNER FIXES                                                  â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  5. OWNER NOTIFIES BACK                                          â”‚
â”‚     â”‚                                                            â”‚
â”‚     â”‚  "âœ… Fixed <file>. Ready for re-test."                    â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  6. LOOP: Re-run checks, repeat if needed                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Notification Templates (VISUAL IMPACT!)

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ  ğŸ”” NOTIFICATION                                                â”ƒ
â”ƒ                                                                 â”ƒ
â”ƒ  FROM: QA Agent                                                 â”ƒ
â”ƒ  TO:   Dev Agent                                                â”ƒ
â”ƒ                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”ƒ
â”ƒ  â”‚  âŒ TEST FAILED                                          â”‚   â”ƒ
â”ƒ  â”‚                                                          â”‚   â”ƒ
â”ƒ  â”‚  File:     cart.spec.ts:45                              â”‚   â”ƒ
â”ƒ  â”‚  Test:     "should calculate total"                     â”‚   â”ƒ
â”ƒ  â”‚  Expected: 100                                          â”‚   â”ƒ
â”ƒ  â”‚  Received: null                                         â”‚   â”ƒ
â”ƒ  â”‚                                                          â”‚   â”ƒ
â”ƒ  â”‚  Likely issue: src/domain/cart/cart.ts:getTotal()       â”‚   â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”ƒ
â”ƒ                                                                 â”ƒ
â”ƒ  ACTION REQUIRED: Fix and notify back                           â”ƒ
â”ƒ                                                                 â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
```

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ  âœ… FIX CONFIRMED                                               â”ƒ
â”ƒ                                                                 â”ƒ
â”ƒ  FROM: Dev Agent                                                â”ƒ
â”ƒ  TO:   QA Agent                                                 â”ƒ
â”ƒ                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”ƒ
â”ƒ  â”‚  Fixed: src/domain/cart/cart.ts                         â”‚   â”ƒ
â”ƒ  â”‚                                                          â”‚   â”ƒ
â”ƒ  â”‚  Problem: getTotal() returned null for empty cart       â”‚   â”ƒ
â”ƒ  â”‚  Solution: Now returns 0 when items.length === 0        â”‚   â”ƒ
â”ƒ  â”‚                                                          â”‚   â”ƒ
â”ƒ  â”‚  Ready for re-test.                                     â”‚   â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”ƒ
â”ƒ                                                                 â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
```

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ  ğŸ”´ BUILD ERROR                                                 â”ƒ
â”ƒ                                                                 â”ƒ
â”ƒ  TO: Dev Agent                                                  â”ƒ
â”ƒ                                                                 â”ƒ
â”ƒ  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”ƒ
â”ƒ  â”‚  Error: Cannot find module './utils'                    â”‚   â”ƒ
â”ƒ  â”‚                                                          â”‚   â”ƒ
â”ƒ  â”‚  File: src/application/useAddToCart.ts:3                â”‚   â”ƒ
â”ƒ  â”‚  Line: import { formatPrice } from './utils'            â”‚   â”ƒ
â”ƒ  â”‚                                                          â”‚   â”ƒ
â”ƒ  â”‚  The file ./utils does not exist.                       â”‚   â”ƒ
â”ƒ  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”ƒ
â”ƒ                                                                 â”ƒ
â”ƒ  ACTION REQUIRED: Fix import and notify back                    â”ƒ
â”ƒ                                                                 â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
```

### Notification Types

| From | To | When | Message |
|------|-----|------|---------|
| **Build** | Dev | Build fails | "ğŸ”´ Build error in {file}: {error}" |
| **QA** | Dev | Test fails on impl | "ğŸ”´ Test failed: {test} - {file}:{line}" |
| **QA** | Architect | Design issue found | "â“ Design unclear: {question}" |
| **QA** | PO | Spec unclear | "â“ Spec question: {question}" |
| **Dev** | QA | Code fixed | "âœ… Fixed {file}, please re-test" |
| **Dev** | Architect | Need type help | "â“ Type issue: {problem}" |
| **Architect** | Dev | Design updated | "ğŸ“ Design changed: re-implement {function}" |
| **Architect** | QA | Type fixed | "âœ… Types updated, re-run checks" |
| **PO** | QA | Spec clarified | "ğŸ“‹ Spec updated: {change}" |
| **PO** | Architect | Requirement changed | "ğŸ“‹ New requirement: {change}" |

### Implementation

```python
def notify_agent(to: str, from_agent: str, error: Error):
    """
    Core notification function.
    NEVER fix directly - always notify the owning agent.
    """

    # Build notification message
    notification = f"""
ğŸ”” NOTIFICATION FROM {from_agent.upper()}

## Error
{error.type}: {error.message}

## Location
File: {error.file}:{error.line}

## Context
{error.context}

## Your Task
1. Analyze the error
2. Fix it in your code
3. Notify back when done: "âœ… Fixed {error.file}"

DO NOT ask the user. Fix it autonomously.
"""

    # Spawn the owning agent
    Task(
        subagent_type=to,
        prompt=notification
    )


def reactive_loop():
    """Main reactive loop with inter-agent notifications."""

    while True:
        # Run all checks
        results = run_checks()  # build, test, types, lint

        if results.all_green:
            print("âœ… ALL GREEN - CRAFT COMPLETE")
            break

        # Process each error
        for error in results.errors:

            # Determine owner based on file location
            owner = get_owner(error.file)

            # NOTIFY the owner (never fix directly!)
            notify_agent(
                to=owner,
                from_agent="orchestrator",
                error=error
            )

        # Wait for agents to fix
        # Agents will notify back when done
        # Then loop continues


def get_owner(file_path: str) -> str:
    """Determine which agent owns this file."""

    if file_path.startswith("e2e/"):
        return "qa-engineer"
    elif file_path.startswith("tests/integration/"):
        return "qa-engineer"
    elif file_path.startswith("src/"):
        return "frontend-engineer"  # or backend-engineer
    elif "design" in file_path:
        return "architect"
    elif "spec" in file_path:
        return "product-owner"
    else:
        return "frontend-engineer"  # default
```

### Example: Full Notification Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                  â”‚
â”‚  SCENARIO: Test fails because of implementation bug              â”‚
â”‚                                                                  â”‚
â”‚  1. QA runs e2e tests                                            â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  2. Test "cart.spec.ts" fails                                    â”‚
â”‚     Error: "Expected 100, got null"                              â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  3. QA NOTIFIES DEV:                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ ğŸ”” NOTIFICATION FROM QA                               â”‚    â”‚
â”‚     â”‚                                                       â”‚    â”‚
â”‚     â”‚ Test failed: cart.spec.ts:45                         â”‚    â”‚
â”‚     â”‚ Expected cart.total to be 100, got null              â”‚    â”‚
â”‚     â”‚                                                       â”‚    â”‚
â”‚     â”‚ This looks like an issue in src/cart.ts              â”‚    â”‚
â”‚     â”‚ The getTotal() function returns null                 â”‚    â”‚
â”‚     â”‚                                                       â”‚    â”‚
â”‚     â”‚ Please fix and notify back.                          â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  4. DEV AGENT receives notification                              â”‚
â”‚     - Analyzes src/cart.ts                                       â”‚
â”‚     - Finds bug in getTotal()                                    â”‚
â”‚     - Fixes it                                                   â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  5. DEV NOTIFIES QA:                                             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚ âœ… FIXED                                              â”‚    â”‚
â”‚     â”‚                                                       â”‚    â”‚
â”‚     â”‚ Fixed src/cart.ts:getTotal()                         â”‚    â”‚
â”‚     â”‚ Was returning null when items empty                  â”‚    â”‚
â”‚     â”‚ Now returns 0                                         â”‚    â”‚
â”‚     â”‚                                                       â”‚    â”‚
â”‚     â”‚ Ready for re-test.                                   â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  6. QA re-runs tests                                             â”‚
â”‚     âœ… All pass                                                  â”‚
â”‚     â”‚                                                            â”‚
â”‚     â–¼                                                            â”‚
â”‚  7. DONE                                                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Rules

1. **NEVER FIX DIRECTLY** â€” Always notify the owning agent
2. **YOU WROTE IT? YOU OWN IT.**
   - `src/**` â†’ Dev owns it
   - `e2e/**` â†’ QA owns it
   - `tests/**` â†’ QA owns it
   - `*.test.ts` (colocated) â†’ Dev owns it
   - Design files â†’ Architect owns it
   - Spec files â†’ PO owns it
3. **ALWAYS NOTIFY BACK** â€” When you fix something, tell the sender
4. **INCLUDE CONTEXT** â€” Don't just say "error", explain what happened
5. **LOOP UNTIL GREEN** â€” Keep notifying until all checks pass

**THIS IS THE CORE OF SPECTRE. Without notifications, there's no reactive loop.**
â”‚              â”‚               â”‚                                  â”‚
â”‚              â–¼               â–¼                                   â”‚
â”‚            DONE!     retry++ < 3?                               â”‚
â”‚                              â”‚                                   â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                      â”‚               â”‚                          â”‚
â”‚                     YES             NO                           â”‚
â”‚                      â”‚               â”‚                          â”‚
â”‚                      â–¼               â–¼                           â”‚
â”‚                 LOOP BACK      /heal to continue                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Error Classification & Routing

**RULE: Error goes back to the agent who wrote that code.**

| Error Location | Who Fixes | Examples |
|----------------|-----------|----------|
| **src/** (implementation) | Dev Agent | Build error, runtime error, logic bug |
| **e2e/** or **tests/** | QA Agent | Test syntax error, selector error, fixture issue |
| **Type error in src/** | Dev Agent | Type mismatch in implementation |
| **Type error in design** | Architect Agent | Wrong interface, missing type |
| **Design flaw** | Architect Agent | Wrong abstraction, coupling |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WHERE IS THE ERROR?                                             â”‚
â”‚                                                                  â”‚
â”‚  src/**/*.ts         â†’ DEV AGENT wrote it, DEV AGENT fixes it   â”‚
â”‚  e2e/**/*.spec.ts    â†’ QA AGENT wrote it, QA AGENT fixes it     â”‚
â”‚  tests/**/*.test.ts  â†’ QA AGENT wrote it, QA AGENT fixes it     â”‚
â”‚  *.test.ts (colocated) â†’ DEV AGENT wrote it, DEV AGENT fixes it â”‚
â”‚  design issue        â†’ ARCHITECT AGENT fixes it                  â”‚
â”‚                                                                  â”‚
â”‚  SIMPLE RULE: You wrote it? You fix it.                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Implementation

```python
# PSEUDO-CODE - The orchestrator does this automatically

retry_count = 0
max_retries = 3

while retry_count < max_retries:
    # Run ALL checks
    build_result = run("npm run build")
    test_result = run("npm test")
    type_result = run("tsc --noEmit")

    errors = collect_errors(build_result, test_result, type_result)

    if not errors:
        print("âœ… ALL GREEN - CRAFT COMPLETE")
        break

    # Route EACH error to the AGENT WHO WROTE THAT CODE
    for error in errors:

        # RULE: You wrote it? You fix it.

        if error.file.startswith("e2e/") or error.file.startswith("tests/"):
            # QA AGENT wrote e2e/integration tests â†’ QA fixes
            Task(subagent_type="qa-engineer", prompt=f"""
                FIX THIS TEST ERROR (you wrote this test):

                File: {error.file}
                Error: {error.message}

                {error.details}

                DO NOT ask the user. Fix it now.
            """)

        elif error.file.startswith("src/") or error.file.endswith(".ts"):
            # DEV AGENT wrote implementation â†’ Dev fixes
            Task(subagent_type="frontend-engineer", prompt=f"""
                FIX THIS ERROR (you wrote this code):

                File: {error.file}
                Error: {error.message}

                {error.details}

                DO NOT ask the user. Fix it now.
            """)

        elif error.type == "type_error" and "design" in error.details.lower():
            # Type error that suggests design issue â†’ Architect
            Task(subagent_type="architect", prompt=f"""
                TYPE ERROR (may need design change):

                {error.details}

                Review if this needs a design update.
            """)

        elif error.type == "design_flaw":
            # Design issue â†’ Architect
            Task(subagent_type="architect", prompt=f"""
                DESIGN FLAW DETECTED:

                {error.details}

                Update design, agents will re-implement.
            """)

    retry_count += 1

if retry_count >= max_retries:
    print("âš ï¸ Max retries. Run /heal to continue.")
```

### Key Rules

1. **CLAUDE NEVER FIXES DIRECTLY** â€” Always spawn an agent
2. **YOU WROTE IT? YOU FIX IT.**
   - Error in `src/` â†’ Dev Agent (wrote implementation)
   - Error in `e2e/` â†’ QA Agent (wrote e2e tests)
   - Error in `tests/` â†’ QA Agent (wrote integration tests)
   - Error in colocated `*.test.ts` â†’ Dev Agent (wrote unit tests)
3. **Design issues â†’ Architect Agent**
4. **Loop until ALL checks pass** or max retries
5. **If stuck** â†’ User runs `/heal`

**Without this routing, the reactive loop is USELESS.**

---
```

---

## Example: With Spec

```
> /craft

ğŸ”® SPECTRE CRAFT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ Do you have a spec or requirements?
   â–¸ âœ… Yes, I have one
   â–¹ ğŸ’¡ No, just an idea

> Yes

ğŸ“ Where's the spec?
   â–¸ ğŸ“ Local file
   â–¹ ğŸ”— URL / Ticket
   â–¹ ğŸ“ Paste it

> Local file â†’ docs/user-auth-spec.md

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    ğŸ’œ PO PHASE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¤ Product Owner analyzing...
   âœ“ Objective clear
   âœ“ 5 acceptance criteria found
   âš ï¸ Missing edge cases â†’ adding
   ğŸ“‹ spec-v2.md drafted

ğŸ”® PO improved your spec. Accept changes?
   â–¸ ğŸ’œ Accept v2
   â–¹ ğŸš« Keep v1
   â–¹ ğŸ’¬ Discuss

> Accept v2

   âœ“ .spectre/specs/functional/spec-v2.md approved

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                 ğŸ’œ ARCHITECT PHASE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ—ï¸ Architect designing...
   âœ“ Hexagonal architecture
   âœ“ 8 files planned
   âœ“ Result<T, E> patterns
   âœ“ design-v1.md ready (based_on: spec-v2)

ğŸ§ª What tests should QA write?
   â–¸ ğŸ­ E2E (Playwright)
   â–¹ ğŸ”Œ Integration

> E2E

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
               ğŸ’œ IMPLEMENTATION PHASE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’» Dev implementing...
   âœ“ Domain layer + unit tests (BDD)
   âœ“ Application layer + unit tests
   âœ“ UI components + unit tests

ğŸ§ª QA writing E2E tests...
   âœ“ e2e/ folder created
   âœ“ Page Objects ready
   âœ“ 7 tests written
   âœ“ Running...
   âœ“ 7/7 passing
   âœ“ 100% spec coverage

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ CRAFT COMPLETE

ğŸ’œ All agents passed. All tests green.
```

---

## Example: Without Spec (Autonomous Fixing Loop)

```
> /craft

ğŸ”® SPECTRE CRAFT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ Do you have a spec or requirements?
   â–¹ âœ… Yes, I have one
   â–¸ ğŸ’¡ No, just an idea

> No

ğŸ¯ What are we building?
   â–¸ âœ¨ New feature
   â–¹ ğŸ› Bug fix
   â–¹ â™»ï¸ Refactor

> New feature

ğŸ’¬ Describe what you want:
> User authentication with email/password and OAuth

ğŸ” Auto-detected: TypeScript + React + Node (monorepo)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                    ğŸ’œ PO PHASE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ‘¤ Product Owner creating spec...
   âœ“ Objective defined
   âœ“ 7 acceptance criteria
   âœ“ Edge cases covered
   ğŸ“‹ spec-v1.md drafted

ğŸ”® Spec ready. Ship it?
   â–¸ ğŸ’œ Let's go!
   â–¹ âœï¸ Needs tweaks

> Let's go!

   âœ“ .spectre/specs/functional/spec-v1.md approved

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                 ğŸ’œ ARCHITECT PHASE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ—ï¸ Architect designing...
   âœ“ Auth module structure
   âœ“ 12 files planned
   âœ“ Security patterns
   âœ“ design-v1.md ready (based_on: spec-v1)

ğŸ§ª What tests should QA write?
   â–¸ ğŸ­ E2E (Playwright)
   â–¹ ğŸ”Œ Integration

> E2E

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
               ğŸ’œ IMPLEMENTATION PHASE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’» Dev implementing...
   âœ“ Domain layer + unit tests
   âœ“ Application layer + unit tests
   âœ“ UI components + unit tests

ğŸ§ª QA writing E2E tests...
   âœ“ e2e/ folder created
   âœ— 2 tests failed

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ”„ SELF-HEALING LOOP (1/3)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ Failures:
   â€¢ oauth-callback.spec.ts â†’ redirect URL mismatch
   â€¢ login-form.spec.ts â†’ missing error message

ğŸ”§ Dev auto-fixing...
   âœ“ Fixed redirect URL in AuthService
   âœ“ Added error display in LoginForm

ğŸ§ª QA re-running...
   âœ— 1 test still failing

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ”„ SELF-HEALING LOOP (2/3)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ Remaining:
   â€¢ oauth-callback.spec.ts â†’ type error in response

ğŸ—ï¸ Architect auto-fixing type...
   âœ“ Updated OAuthResponse type

ğŸ”§ Dev re-implementing...
   âœ“ Applied type fix

ğŸ§ª QA re-running...
   âœ“ 9/9 E2E tests passing
   âœ“ 100% spec coverage

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ¨ CRAFT COMPLETE

ğŸ’œ All agents passed. All tests green.

ğŸ“ Output:
   spec-v1.md      functional spec
   design-v2.md    design (updated after type fix)
   src/auth/       implementation
   e2e/auth/       E2E tests
```

---

## Summary

| Step | Question | When |
|------|----------|------|
| Step | Question | When |
|------|----------|------|
| 1 | "What do you want to do?" | If project exists |
| 1b | "What's your stack?" | If no project |
| 2 | "Do you have a spec?" | If not "Craft the existing" |
| 3a | "Where is it?" | If has spec |
| 3b | "Describe what you want" | If no spec |
| **3c** | **"Want QA tests?"** | **UPFRONT â€” before chain starts** |
| 3c+ | "Test type? Same repo?" | If QA enabled |
| 4 | "Accept spec changes?" | After PO review |

| Agent | Runs | Output |
|-------|------|--------|
| PO | If not "Craft the existing" | `.spectre/specs/functional/spec-vN.md` |
| Learning | **ALWAYS** | `.spectre/context.json`, `stack-skills.json` |
| Architect | **ALWAYS** | `.spectre/specs/design/design-vN.md` |
| Dev | **ALWAYS** | Implementation + Unit tests (BDD) |
| QA | **OPTIONAL** | E2E or Integration tests |

### QA Options

| Option | Description |
|--------|-------------|
| Skip QA | Dev only with unit tests |
| QA in same repo | Tests in `e2e/` or `tests/integration/` |
| QA in different repo | Clone, write, push to separate repo |

### Folder Structure

```
.spectre/specs/
â”œâ”€â”€ functional/           # PO's versioned specs
â”‚   â”œâ”€â”€ spec-v1.md        # version: 1.0.0 â€” IMMUTABLE
â”‚   â”œâ”€â”€ spec-v2.md        # version: 2.0.0
â”‚   â””â”€â”€ ...
â””â”€â”€ design/               # Architect's versioned designs
    â”œâ”€â”€ design-v1.md      # version: 1.0.0, based_on: spec-v2.md
    â””â”€â”€ ...

# If QA in different repo:
.spectre/test-repo/       # Cloned test repository
â”œâ”€â”€ e2e/
â””â”€â”€ integration/
```

### Golden Rules

1. **VERSION IS THE KEY** â€” Everything is versioned
2. **NEVER MODIFY ORIGINALS** â€” Always create new version
3. **HISTORY IS SACRED** â€” Every version preserved forever
4. **FRONTMATTER REQUIRED** â€” version, status, parent, based_on
5. **QA IS OPTIONAL** â€” User decides if E2E/Integration needed

| Test Type | Responsibility | Location |
|-----------|----------------|----------|
| Unit (BDD) | **Developer** | Colocated `*.test.ts` |
| E2E | **QA** (optional) | `e2e/` or separate repo |
| Integration | **QA** (optional) | `tests/integration/` or separate repo |

**Professional. Smart. Flexible.**
